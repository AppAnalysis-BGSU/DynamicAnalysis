package com.apsalar.sdk;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.content.SharedPreferences.Editor;
import android.database.Cursor;
import android.net.Uri;
import android.os.Looper;
import android.util.Log;
import android.webkit.WebView;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ExecutionException;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

public class Apsalar {
    protected static final boolean DEBUG = false;
    protected static final boolean ERROR = false;
    private static final String FACEBOOK_ATTRIBUTION_ID_URL = "content://com.facebook.katana.provider.AttributionIdProvider";
    protected static String FBAppId = "";
    protected static String FBCookie = "";
    private static String apiKey = "";
    protected static Context ctx = null;
    static HashSet<String> executed_triggers = new HashSet();
    private static final char[] hexDigits = new char[]{'0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f'};
    protected static ApsalarSessionInfo info = null;
    static HashMap<String, ApsalarItem> registered_callbacks = new HashMap();
    static HashMap<String, ApsalarItem> registered_triggers = new HashMap();
    private static String secret = "";
    protected static ApsalarThread thread = null;
    static Boolean triggerActive = Boolean.valueOf(false);

    private static void resetCaches() {
        registered_callbacks.clear();
        registered_triggers.clear();
        executed_triggers.clear();
    }

    private static String[] findStartSessionTrigger(Intent intent) {
        if (intent.getScheme() == null) {
            return new String[0];
        }
        Uri data = intent.getData();
        if (data == null || !data.getHost().equals("e.apsalar.com") || !data.getPath().startsWith("/api/v1/appstore/")) {
            return new String[0];
        }
        List pathSegments = data.getPathSegments();
        if (pathSegments.size() < 5) {
            return new String[0];
        }
        if (executed_triggers.contains((String) pathSegments.get(4))) {
            return new String[0];
        }
        return new String[]{(String) pathSegments.get(4), data.getEncodedQuery()};
    }

    public static void setInfo(Context context, String str, String str2) {
        if (context != null && str != null && str2 != null) {
            ctx = context;
            apiKey = str;
            secret = str2;
            info = new ApsalarSessionInfo(ctx, apiKey, secret);
        }
    }

    public static void startSession(Context context, String str, String str2) {
        String facebookAttributionId;
        if (context instanceof Activity) {
            String[] findStartSessionTrigger = findStartSessionTrigger(((Activity) context).getIntent());
            if (info == null) {
                setInfo(context, str, str2);
            }
            if (!(ctx == null || info == null || thread != null)) {
                thread = ApsalarThread.getInstance(ctx, apiKey, secret);
            }
            if (info != null && info.sessionStart == 0 && thread != null) {
                Object apsalarSession;
                info.sessionStart = System.currentTimeMillis();
                if (findStartSessionTrigger.length <= 0 || findStartSessionTrigger[0] == null) {
                    apsalarSession = new ApsalarSession(info);
                } else {
                    apsalarSession = new ApsalarSession(info, new LoadTriggerTask(info, context), findStartSessionTrigger);
                }
                facebookAttributionId = new Apsalar().getFacebookAttributionId();
                if (facebookAttributionId != null) {
                    Map hashMap = new HashMap();
                    hashMap.put("fb_cookie", facebookAttributionId);
                    saveFBCookie(context, hashMap);
                }
                if (!thread.events.offer(apsalarSession)) {
                    return;
                }
                return;
            } else if (findStartSessionTrigger.length > 0 && findStartSessionTrigger[0] != null) {
                LoadTriggerTask loadTriggerTask = new LoadTriggerTask(info, context);
                if (findStartSessionTrigger.length > 1) {
                    loadTriggerTask.execute(new String[]{findStartSessionTrigger[0], findStartSessionTrigger[1]});
                    return;
                }
                loadTriggerTask.execute(new String[]{findStartSessionTrigger[0]});
                return;
            } else {
                return;
            }
        }
        if (info == null) {
            setInfo(context, str, str2);
        }
        if (!(ctx == null || info == null || thread != null)) {
            thread = ApsalarThread.getInstance(ctx, apiKey, secret);
        }
        if (info != null && info.sessionStart == 0 && thread != null) {
            info.sessionStart = System.currentTimeMillis();
            ApsalarSession apsalarSession2 = new ApsalarSession(info);
            facebookAttributionId = new Apsalar().getFacebookAttributionId();
            if (facebookAttributionId != null) {
                hashMap = new HashMap();
                hashMap.put("fb_cookie", facebookAttributionId);
                saveFBCookie(context, hashMap);
            }
            if (!thread.events.offer(apsalarSession2)) {
            }
        }
    }

    public static void restartSession(Context context, String str, String str2) {
        if (info != null) {
            info = null;
            thread = null;
            startSession(context, str, str2);
        }
    }

    public static void restartSession() {
        if (info != null && ctx != null) {
            restartSession(ctx, apiKey, secret);
        }
    }

    public static void endSession() {
        if (info != null && info.sessionStart != 0) {
            int intValue;
            ApsalarEndSession apsalarEndSession = new ApsalarEndSession(info);
            if (Looper.getMainLooper().getThread() == Thread.currentThread()) {
                EndSessionTask endSessionTask = new EndSessionTask();
                endSessionTask.execute(new ApsalarEvent[]{apsalarEndSession});
                try {
                    intValue = ((Integer) endSessionTask.get()).intValue();
                } catch (InterruptedException e) {
                    intValue = -1;
                } catch (ExecutionException e2) {
                    intValue = -1;
                }
            } else {
                intValue = apsalarEndSession.REST();
            }
            switch (intValue) {
                case 0:
                    if (!thread.events.offer(apsalarEndSession)) {
                        break;
                    }
                    break;
            }
            if (thread != null) {
                thread.lastSessionInfo = null;
            }
            info.sessionStart = 0;
        }
    }

    public static void event(String str) {
        event(str, new JSONObject());
    }

    public static void event(String str, Object... objArr) {
        if (objArr.length % 2 == 0) {
            JSONObject jSONObject = new JSONObject();
            int i = 0;
            while (i < objArr.length) {
                try {
                    jSONObject.put((String) objArr[i], objArr[i + 1]);
                    i += 2;
                } catch (JSONException e) {
                    return;
                }
            }
            event(str, jSONObject);
        }
    }

    public static void event(String str, JSONObject jSONObject) {
        if (info != null && info.sessionStart != 0 && thread != null) {
            if (!thread.events.offer(new ApsalarEvent(info, str, jSONObject.toString()))) {
            }
        }
    }

    public static void eventJSON(String str, JSONObject jSONObject) {
        event(str, jSONObject);
    }

    public static void survey(Activity activity, String str) {
        if (info != null && info.sessionStart != 0 && !triggerActive.booleanValue()) {
            Intent intent = new Intent(activity, Activity.class);
            intent.putExtra("op", "survey");
            intent.putExtra("survey", str);
            activity.startActivity(intent);
        }
    }

    public static void setGender(String str) {
        if (str == null) {
            return;
        }
        if (str.toLowerCase().equals(Character.valueOf('f')) || str.toLowerCase().equals(Character.valueOf('f'))) {
            event("__gender__", str);
        }
    }

    public static void setAge(int i) {
        if (i > 0 && i < 100) {
            event("__age__", Integer.toString(i));
        }
    }

    public static void sendReferrerInstall() {
        HashMap hashMap = (HashMap) ApsalarReceiver.retrieveCSIReferrer(ctx);
        JSONObject jSONObject = new JSONObject();
        for (String str : hashMap.keySet()) {
            if (str.equals("referrer")) {
                try {
                    jSONObject.put("referrer", hashMap.get(str));
                } catch (JSONException e) {
                }
            }
        }
        if (jSONObject.length() > 0) {
            event("__InstallReferrer", jSONObject);
        }
    }

    private static Boolean callbackIsKnown(String str) {
        if (registered_callbacks == null) {
            return Boolean.valueOf(false);
        }
        return Boolean.valueOf(registered_callbacks.containsKey(str));
    }

    private static Boolean triggerIsKnown(String str) {
        if (registered_triggers == null) {
            return Boolean.valueOf(false);
        }
        return Boolean.valueOf(registered_triggers.containsKey(str));
    }

    public static void registerCallback(String str, Object obj) {
        String replace = str.replace(" ", "");
        if (!(info == null || info.sessionStart == 0 || thread == null || !replace.matches("[^)]+\\([^]]*\\)") || callbackIsKnown(replace).booleanValue())) {
            new ApsalarRegister("C", replace, info).REST();
        }
        ApsalarItem apsalarItem = (ApsalarItem) registered_callbacks.get(replace);
        if (apsalarItem == null) {
            registered_callbacks.put(replace, new ApsalarItem(replace, obj));
            return;
        }
        apsalarItem.val = obj;
        Log.d(new Boolean(apsalarItem.val instanceof WebView).toString(), "Callback is a Webview ");
    }

    private static void registerTrigger(String str) {
        if (!(info == null || info.sessionStart == 0 || thread == null || triggerIsKnown(str).booleanValue())) {
            new ApsalarRegister("T", str, info).REST();
        }
        registered_triggers.put(str, new ApsalarItem(str, Boolean.valueOf(true)));
    }

    public static void trigger(Activity activity, String str) {
        if (info != null && info.sessionStart != 0 && registered_triggers != null) {
            ApsalarItem apsalarItem = (ApsalarItem) registered_triggers.get(str);
            if (apsalarItem != null && apsalarItem.connected.booleanValue() && apsalarItem.registered.booleanValue()) {
                new LoadTriggerTask(info, activity).execute(new String[]{apsalarItem.name});
            } else if (apsalarItem == null) {
                registerTrigger(str);
            } else if (!apsalarItem.connected.booleanValue()) {
            }
        }
    }

    public static void setFBAppId(String str) {
        if (str != null) {
            FBAppId = str;
        }
    }

    protected static String getNewSessionId() {
        return UUID.randomUUID().toString();
    }

    protected static String hexDigest(byte[] bArr) {
        StringBuffer stringBuffer = new StringBuffer();
        for (int i = 0; i < bArr.length; i++) {
            stringBuffer.append(hexDigits[(bArr[i] & 240) >>> 4]);
            stringBuffer.append(hexDigits[bArr[i] & 15]);
        }
        return stringBuffer.toString();
    }

    public static void setTimeouts(int i) {
        ApsalarEvent.client.getParams().setParameter("http.connection.timeout", new Integer(i));
        ApsalarEvent.client.getParams().setParameter("http.socket.timeout", new Integer(i));
    }

    public static String getDeviceId() {
        if (info == null || info.deviceId == null) {
            return "None";
        }
        return info.deviceId;
    }

    public static String getSessionId() {
        if (info == null || info.sessionId == null) {
            return "None";
        }
        return info.sessionId;
    }

    public static void sendFBInstall() {
        Object obj = null;
        if (ctx != null) {
            Map retrieveFBCookie = retrieveFBCookie(ctx);
            if (retrieveFBCookie != null) {
                obj = (String) retrieveFBCookie.get("fb_cookie");
            }
        }
        if (FBAppId != null && obj != null) {
            JSONObject jSONObject = new JSONObject();
            JSONArray jSONArray = new JSONArray();
            jSONArray.put(FBAppId);
            try {
                jSONObject.put("fb_app_attribution", obj);
                jSONObject.put("fb_app_ids", jSONArray);
            } catch (JSONException e) {
                e.printStackTrace();
            }
            event("__FBInstall", jSONObject);
        }
    }

    public static Map<String, String> retrieveFBCookie(Context context) {
        String packageName = context.getPackageName();
        Map hashMap = new HashMap();
        SharedPreferences sharedPreferences = context.getSharedPreferences("apsalar_" + packageName, 0);
        for (String packageName2 : sharedPreferences.getAll().keySet()) {
            String string = sharedPreferences.getString(packageName2, null);
            if (string != null) {
                hashMap.put(packageName2, string);
            }
        }
        return hashMap;
    }

    public static void saveFBCookie(Context context, Map<String, String> map) {
        Editor edit = context.getSharedPreferences("apsalar_" + context.getPackageName(), 0).edit();
        for (String str : map.keySet()) {
            String str2 = (String) map.get(str);
            if (str2 != null) {
                edit.putString(str, str2);
            }
        }
        edit.commit();
    }

    private String getFacebookAttributionId() {
        Cursor query;
        try {
            query = ctx.getContentResolver().query(Uri.parse(FACEBOOK_ATTRIBUTION_ID_URL), null, null, null, null);
        } catch (Exception e) {
            query = null;
        }
        if (query == null) {
            return null;
        }
        query.moveToFirst();
        String string = query.getString(0);
        query.close();
        return string;
    }
}
