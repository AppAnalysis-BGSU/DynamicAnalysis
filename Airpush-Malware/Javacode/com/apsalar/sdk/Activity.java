package com.apsalar.sdk;

import android.content.Intent;
import android.content.res.Configuration;
import android.os.Bundle;
import android.util.DisplayMetrics;
import android.view.View;
import android.view.ViewGroup.LayoutParams;
import android.view.inputmethod.InputMethodManager;
import android.webkit.WebView;
import com.adsdk.sdk.Const;
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;

public class Activity extends android.app.Activity {
    private static final String apSurveyBase = "http://apsalar.com/api/survey/boot/do";

    public void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        Intent intent = getIntent();
        String stringExtra = intent.getStringExtra("op");
        String str = "about:close";
        if (stringExtra.equals("survey")) {
            load(apSurveyBase + seal(intent.getStringExtra("survey")));
        } else if (stringExtra.equals("ad")) {
            loadHTML(intent.getStringExtra("content"));
        }
    }

    private void load(String str) {
        View webView = new WebView(this);
        webView.setVerticalScrollBarEnabled(false);
        webView.setWebViewClient(new ApWebViewClient());
        webView.getSettings().setJavaScriptEnabled(true);
        webView.getSettings().setSavePassword(false);
        addContentView(webView, new LayoutParams(-1, -1));
        try {
            webView.loadData("<html><head>" + URLEncoder.encode("", Const.ENCODING) + "<script type=\"text/javascript\">" + "function load(){" + "var s=document.createElement('script');" + "s.type='text/javascript';" + "s.src='" + URLEncoder.encode(str, Const.ENCODING) + "';" + "document.getElementsByTagName('head')[0].appendChild(s);" + "}" + "document.addEventListener('DOMContentLoaded', function(){" + "load();" + "setTimeout('load();', 2000);" + "setTimeout('load();', 5000);" + "setTimeout('load();', 10000);" + "}, false);" + "</script>" + "</head>" + "<body><h1 style=\"color: #aaa;\">" + "Loading...</h1><p><a href=\"about:close\">" + "<input type=\"submit\" value=\"Close\"></a></p>" + "</body></html>", "text/html", Const.ENCODING);
        } catch (UnsupportedEncodingException e) {
            webView.loadData("<h1>Error</h1><p><a href=\"about:close\">Close</a></p>\n", "text/html", "utf-8");
        }
        webView.requestFocus();
        ((InputMethodManager) getSystemService("input_method")).hideSoftInputFromWindow(webView.getWindowToken(), 2);
    }

    protected String seal(String str) {
        try {
            String hexDigest;
            DisplayMetrics displayMetrics = new DisplayMetrics();
            getWindowManager().getDefaultDisplay().getMetrics(displayMetrics);
            String str2 = "?a=" + URLEncoder.encode(Apsalar.info.apiKey, Const.ENCODING) + "&i=" + URLEncoder.encode(Apsalar.info.clsPackage, Const.ENCODING) + "&p=" + URLEncoder.encode(Apsalar.info.platform, Const.ENCODING) + "&s=" + URLEncoder.encode(Apsalar.info.sessionId, Const.ENCODING) + "&sdk=" + URLEncoder.encode(Apsalar.info.sdkVersion, Const.ENCODING) + "&sh=" + displayMetrics.heightPixels + "&sw=" + displayMetrics.widthPixels + "&u=" + URLEncoder.encode(Apsalar.info.deviceId, Const.ENCODING) + "&y=" + URLEncoder.encode(str, Const.ENCODING);
            try {
                MessageDigest instance = MessageDigest.getInstance("SHA-1");
                instance.update(Apsalar.info.secret.getBytes(Const.ENCODING));
                instance.update(str2.getBytes(Const.ENCODING));
                hexDigest = Apsalar.hexDigest(instance.digest());
            } catch (UnsupportedEncodingException e) {
                hexDigest = "error=369";
            } catch (NoSuchAlgorithmException e2) {
                hexDigest = "error=373";
            }
            return str2 + "&h=" + hexDigest;
        } catch (UnsupportedEncodingException e3) {
            return "?error=371";
        }
    }

    public void onConfigurationChanged(Configuration configuration) {
        super.onConfigurationChanged(configuration);
    }

    private void loadHTML(String str) {
        View webView = new WebView(this);
        webView.getSettings().setJavaScriptEnabled(true);
        webView.setWebViewClient(new ApWebViewClient());
        setContentView(webView);
        webView.loadDataWithBaseURL(null, "<html><head></head><body>" + str + "</body></html>", "text/html", Const.ENCODING, null);
        webView.requestFocus();
    }
}
