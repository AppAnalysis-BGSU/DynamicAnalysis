package com.adsdk.sdk;

import com.adsdk.sdk.video.ResponseHandler;
import com.adsdk.sdk.video.RichMediaAd;
import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.NoSuchElementException;
import java.util.Scanner;
import javax.xml.parsers.SAXParserFactory;
import org.xml.sax.InputSource;
import org.xml.sax.XMLReader;

public class RequestRichMediaAd extends RequestAd<RichMediaAd> {
    public RequestRichMediaAd() {
        this.is = null;
    }

    public RequestRichMediaAd(InputStream xmlArg) {
        this.is = xmlArg;
    }

    RichMediaAd parseTestString() throws RequestException {
        try {
            XMLReader xr = SAXParserFactory.newInstance().newSAXParser().getXMLReader();
            ResponseHandler myHandler = new ResponseHandler();
            xr.setContentHandler(myHandler);
            xr.parse(new InputSource(new InputStreamReader(this.is, Const.ENCODING)));
            return myHandler.getRichMediaAd();
        } catch (Exception e) {
            throw new RequestException("Cannot parse Response:" + e.getMessage(), e);
        }
    }

    RichMediaAd parse(InputStream inputStream) throws RequestException {
        try {
            XMLReader xr = SAXParserFactory.newInstance().newSAXParser().getXMLReader();
            ResponseHandler myHandler = new ResponseHandler();
            xr.setContentHandler(myHandler);
            InputSource src;
            if (Log.LOGGING_ENABLED) {
                String response = convertStreamToString(inputStream);
                Log.m0d("Ad RequestPerform HTTP Response: " + response);
                src = new InputSource(new ByteArrayInputStream(response.getBytes(Const.RESPONSE_ENCODING)));
                src.setEncoding(Const.RESPONSE_ENCODING);
                xr.parse(src);
                return myHandler.getRichMediaAd();
            }
            src = new InputSource(inputStream);
            src.setEncoding(Const.RESPONSE_ENCODING);
            xr.parse(src);
            return myHandler.getRichMediaAd();
        } catch (Exception e) {
            throw new RequestException("Cannot parse Response:" + e.getMessage(), e);
        }
    }

    private String convertStreamToString(InputStream is) {
        try {
            return new Scanner(is).useDelimiter("\\A").next();
        } catch (NoSuchElementException e) {
            return "";
        }
    }
}
